#!/usr/bin/env zsh

OP_AUTH_ITEM_NAME_APTIBLE="${OP_AUTH_ITEM_NAME_APTIBLE:-Aptible}"
OP_AUTH_ITEM_NAME_AWS="${OP_AUTH_ITEM_NAME_AWS:-AWS}"

case "$1" in
	auth)
		local account="$2"
		case "$account" in
			aptible)
				local aptible_email
				aptible_email="$(
					op read "op://Private/${OP_AUTH_ITEM_NAME_APTIBLE}/email"
				)"

				local aptible_password
				aptible_password="$(
					op read "op://Private/${OP_AUTH_ITEM_NAME_APTIBLE}/password"
				)"

				local aptible_otp_token
				aptible_otp_token="$(
					op read "op://Private/${OP_AUTH_ITEM_NAME_APTIBLE}/one-time-password?attribute=otp"
				)"

				command aptible login \
					--email="$aptible_email" \
					--password="$aptible_password" \
					--otp-token="$aptible_otp_token" \
					--lifetime=24
				;;

			aws)
				local aws_expiration_datestamp
				aws_expiration_datestamp="$(aws configure --profile="$profile" get aws_session_expiration)"

				local aws_expiration_unix_time
				aws_expiration_unix_time="$(date --date="$aws_expiration_datestamp" '+%s')"

				local unix_time
				unix_time="$(date '+%s')"

				if (( aws_expiration_unix_time < unix_time )); then
					return 0
				fi

				local aws_username
				aws_username="$(op read "op://Private/${OP_AUTH_ITEM_NAME_AWS}/username")"

				local aws_password
				aws_password="$(op read "op://Private/${OP_AUTH_ITEM_NAME_AWS}/password")"

				local aws_otp_token
				aws_otp_token="$(op read "op://Private/${OP_AUTH_ITEM_NAME_AWS}/one-time password?attribute=otp")"

				IFS=$'\t' read -r aws_access_key_id aws_secret_access_key aws_session_token aws_session_expiration < <(
					command aws sts get-session-token \
						--region=us-east-1 \
						--duration=28800 \
						--serial-number="arn:aws:iam::${OP_AUTH_ITEM_NAME_AWS_ACCOUNT_ID:-209595011230}:mfa/${OP_AUTH_AWS_MFA_NAME:-$aws_username}" \
						--token-code="$aws_otp_token" \
						--query='Credentials.[AccessKeyId, SecretAccessKey, SessionToken, Expiration]' \
						--output=text
				)

				aws configure --profile='session' set aws_access_key_id "$aws_access_key_id"
				aws configure --profile='session' set aws_secret_access_key "$aws_secret_access_key"
				aws configure --profile='session' set aws_session_token "$aws_session_token"
				aws configure --profile='session' set aws_session_expiration "$aws_session_expiration"
				;;

			*)
				return 1
				;;
		esac
		;;

	*)
		command op "$@"
		;;
esac
